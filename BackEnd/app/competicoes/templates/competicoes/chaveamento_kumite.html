{% load static %}

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <title>{{ competicao.nome }} - Kumitê {{ categoria.nome }}</title>
    <style>
        :root {
            --primary-color: #198754;
            --secondary-color: #0d6efd;
            --dark-color: #212529;
            --light-color: #f8f9fa;
        }

        body {
            background-color: #f5f5f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .content {
            margin-left: 250px;
            transition: all 0.3s;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), #0a5a3e);
            color: white;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .match-card {
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            border: none;
            overflow: hidden;
        }

        .match-header {
            background: linear-gradient(135deg, #343A40, #343A40);
            color: white;
            padding: 12px 20px;
            font-weight: 600;
        }

        .athlete-info {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .athlete-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            border: 2px solid #ddd;
        }

        .score-input {
            width: 60px;
            text-align: center;
            font-weight: bold;
            border: 2px solid #ddd;
            padding: 5px;
        }

        .timer-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--dark-color);
            text-align: center;
            margin: 10px 0;
        }

        .control-btn {
            border-radius: 5px;
            padding: 5px 10px;
            font-size: 0.9rem;
            margin: 0 2px;
        }

        .match-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .match-status-badge {
            font-size: 0.8rem;
            padding: 5px 10px;
        }

        .global-controls {
            background: linear-gradient(135deg, #343A40, #343A40);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .penalty-badge {
            font-size: 0.75rem;
            margin-left: 5px;
        }

        .bye-badge {
            background-color: #6c757d;
        }

        .disabled-input {
            background-color: #e9ecef;
            cursor: not-allowed;
        }

        .champion-badge {
            background: linear-gradient(135deg, #ffd700, #c9b037);
            color: #000;
            font-weight: bold;
        }

        .modal-center {
            display: flex;
            align-items: center;
            min-height: calc(100% - 1rem);
        }

        .modal-center .modal-dialog {
            margin: 0 auto;
        }

        .modal-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .phase-title {
            background: linear-gradient(135deg, #343A40, #343A40);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            margin: 20px 0 10px;
        }

        .bracket-connector {
            position: relative;
            height: 50px;
            margin: 5px 0;
        }

        .bracket-connector::before {
            content: "";
            position: absolute;
            top: 0;
            left: 50%;
            width: 2px;
            height: 100%;
            background-color: #6c757d;
        }

        .bracket-connector::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 2px;
            background-color: #6c757d;
        }
    </style>
</head>
<body>

    {% include 'sidebar.html' %}

    <!-- Conteúdo Principal -->
    <div class="content" id="content">
        <div class="header d-flex align-items-center justify-content-between" style="background: #343A40;">
            <div class="d-flex align-items-center">
                <i class="bi bi-arrow-left back-icon me-3" onclick="window.history.back()" style="cursor: pointer;"></i>
                <div>
                    <h2 class="mb-0 fw-bold">{{ competicao.nome }} - Kumitê {{ categoria.nome }}</h2>
                    <small class="text-white-50">{{ competicao.descricao|default:"Competição de Karatê" }}</small>
                </div>
            </div>
            <div>
                <span class="badge bg-light text-dark fs-6 me-2">
                    <i class="bi bi-people-fill me-1"></i> {{ num_atletas }} Atletas
                </span>
                <span class="badge bg-light text-dark fs-6">
                    <i class="bi bi-trophy me-1"></i> Fase {{ current_phase }}/{{ max_phases }}
                </span>
            </div>
        </div>

        <!-- Mensagens de alerta -->
        {% if messages %}
            {% for message in messages %}
            <div class="container mt-3">
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>{{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
            {% endfor %}
        {% endif %}

        <!-- Controles Globais -->
        <div class="container mt-3">
            <div class="global-controls">
                <div class="row align-items-center">
                    <div class="col-md-4 mb-2">
                        <select class="form-select form-select-sm" id="areaFilter">
                            <option selected>Todas as Áreas</option>
                            {% for partida in partidas %}
                                <option>Área {{ partida.area }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4 mb-2 text-center">
                        <button class="btn btn-light btn-sm me-2" onclick="startAllMatches()">
                            <i class="bi bi-play-circle"></i> Iniciar Todas
                        </button>
                        <button class="btn btn-light btn-sm" onclick="pauseAllMatches()">
                            <i class="bi bi-pause-circle"></i> Pausar Todas
                        </button>
                    </div>
                    <div class="col-md-4 mb-2 text-end">
                        {% if not is_final %}
                        <button class="btn btn-warning btn-sm me-2" data-bs-toggle="modal" data-bs-target="#advanceModal">
                            <i class="bi bi-arrow-right-circle"></i> Avançar Vencedores
                        </button>
                        {% endif %}
                        <button class="btn btn-light btn-sm" onclick="window.print()">
                            <i class="bi bi-printer"></i> Imprimir
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fases do Torneio -->
        <div class="container mt-4">
            <h4 class="phase-title">
                <i class="bi bi-{% if is_final %}trophy{% else %}diagram-2{% endif %} me-2"></i>
                {{ fase_atual }}
            </h4>

            <!-- Grid de Partidas -->
            <div class="match-grid">
                {% for partida in partidas %}
                <div class="card match-card" id="match-{{ partida.numero }}">
                    <div class="match-header d-flex justify-content-between align-items-center">
                        <span>Partida #{{ partida.numero }} - Área {{ partida.area }}</span>
                        <span class="badge match-status-badge bg-secondary">Não Iniciada</span>
                    </div>
                    <div class="card-body p-0">
                        <!-- Atleta AKA -->
                        <div class="athlete-info">
                            <img src="{% if partida.aka and partida.aka.foto %}{{ partida.aka.foto.url }}{% else %}{% static 'competicoes/img/foto_atleta.png' %}{% endif %}"
                                 class="athlete-avatar" alt="Atleta AKA">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    {% if partida.aka %}
                                        {{ partida.aka.nome_completo }}
                                    {% else %}
                                        <span class="text-muted">Bye</span>
                                    {% endif %}
                                </h6>
                                <small class="text-muted">
                                    AKA | {% if partida.aka and partida.aka.academia %}{{ partida.aka.academia.nome }}{% else %}--{% endif %}
                                </small>
                                <div class="penalties mt-1" data-match="{{ partida.numero }}" data-athlete="1"></div>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="me-2 fw-bold">Pontos:</span>
                                <input type="number" class="score-input" value="0" min="0"
                                       data-match="{{ partida.numero }}" data-athlete="1" {% if not partida.aka %}disabled{% endif %}>
                            </div>
                            {% if partida.aka %}
                            <button class="btn btn-sm btn-outline-danger ms-2" onclick="showPenaltyModal({{ partida.numero }},1)">
                                <i class="bi bi-exclamation-triangle"></i>
                            </button>
                            {% else %}
                            <span class="badge bye-badge ms-2">BYE</span>
                            {% endif %}
                        </div>

                        <!-- Atleta AO -->
                        <div class="athlete-info">
                            <img src="{% if partida.ao and partida.ao.foto %}{{ partida.ao.foto.url }}{% else %}{% static 'competicoes/img/foto_atleta.png' %}{% endif %}"
                                 class="athlete-avatar" alt="Atleta AO">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    {% if partida.ao %}
                                        {{ partida.ao.nome_completo }}
                                    {% else %}
                                        <span class="text-muted">Bye</span>
                                    {% endif %}
                                </h6>
                                <small class="text-muted">
                                    AO | {% if partida.ao and partida.ao.academia %}{{ partida.ao.academia.nome }}{% else %}--{% endif %}
                                </small>
                                <div class="penalties mt-1" data-match="{{ partida.numero }}" data-athlete="2"></div>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="me-2 fw-bold">Pontos:</span>
                                <input type="number" class="score-input" value="0" min="0"
                                       data-match="{{ partida.numero }}" data-athlete="2" {% if not partida.ao %}disabled{% endif %}>
                            </div>
                            {% if partida.ao %}
                            <button class="btn btn-sm btn-outline-danger ms-2" onclick="showPenaltyModal({{ partida.numero }},2)">
                                <i class="bi bi-exclamation-triangle"></i>
                            </button>
                            {% else %}
                            <span class="badge bye-badge ms-2">BYE</span>
                            {% endif %}
                        </div>

                        <!-- Controles da Partida -->
                        <div class="p-3 border-top">
                            <div class="timer-display" data-match="{{ partida.numero }}">02:00</div>
                            <div class="d-flex justify-content-between">
                                <div>
                                    <button class="btn btn-sm btn-primary control-btn" onclick="toggleMatchTimer({{ partida.numero }})">
                                        <i class="bi bi-play-fill"></i> Play
                                    </button>
                                    <button class="btn btn-sm btn-secondary control-btn" onclick="resetMatchTimer({{ partida.numero }})">
                                        <i class="bi bi-arrow-counterclockwise"></i>
                                    </button>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-success control-btn" onclick="prepareFinishMatch({{ partida.numero }})">
                                        <i class="bi bi-flag-fill"></i> Finalizar
                                    </button>
                                    <button class="btn btn-sm btn-danger control-btn" onclick="prepareCancelMatch({{ partida.numero }})">
                                        <i class="bi bi-x-circle-fill"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="d-flex justify-content-center mt-2">
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="addPoint({{ partida.numero }},1)" {% if not partida.aka %}disabled{% endif %}>
                                    +1 AKA
                                </button>
                                <button class="btn btn-sm btn-outline-warning me-1" onclick="addTime({{ partida.numero }},10)">
                                    +10s
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="addPoint({{ partida.numero }},2)" {% if not partida.ao %}disabled{% endif %}>
                                    +1 AO
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Visualização do Chaveamento -->
            <div class="card mt-4">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Resumo do Chaveamento</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Partida</th>
                                    <th>Área</th>
                                    <th>Atleta AKA</th>
                                    <th>Pontos</th>
                                    <th>Atleta AO</th>
                                    <th>Pontos</th>
                                    <th>Status</th>
                                    <th>Tempo</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for partida in partidas %}
                                <tr>
                                    <td>#{{ partida.numero }}</td>
                                    <td>Área {{ partida.area }}</td>
                                    <td>{% if partida.aka %}{{ partida.aka.nome_completo }}{% else %}<span class="text-muted">Bye</span>{% endif %}</td>
                                    <td class="fw-bold">0</td>
                                    <td>{% if partida.ao %}{{ partida.ao.nome_completo }}{% else %}<span class="text-muted">Bye</span>{% endif %}</td>
                                    <td class="fw-bold">0</td>
                                    <td><span class="badge bg-secondary">Não Iniciada</span></td>
                                    <td>02:00</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" onclick="focusMatch({{ partida.numero }})">
                                            <i class="bi bi-zoom-in"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Finalizar Partida -->
    <div class="modal fade" id="finishMatchModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="bi bi-flag-fill me-2"></i> Finalizar Partida</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="modal-icon text-success">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                    <h5>Deseja finalizar esta partida?</h5>
                    <p>Após confirmar, os resultados serão salvos e não poderão ser alterados.</p>
                    <div class="d-flex justify-content-center gap-3 mt-4">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-success" id="confirmFinishMatch">Finalizar Partida</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Cancelar Partida -->
    <div class="modal fade" id="cancelMatchModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-x-circle-fill me-2"></i> Cancelar Partida</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="modal-icon text-danger">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                    </div>
                    <h5>Deseja cancelar esta partida?</h5>
                    <p>Esta ação não pode ser desfeita. Todos os dados serão perdidos.</p>
                    <div class="d-flex justify-content-center gap-3 mt-4">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Voltar</button>
                        <button type="button" class="btn btn-danger" id="confirmCancelMatch">Cancelar Partida</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Avançar Vencedores -->
    <div class="modal fade" id="advanceModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="bi bi-arrow-right-circle-fill me-2"></i> Avançar Vencedores</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead class="table-warning">
                                <tr>
                                    <th>Partida</th>
                                    <th>Vencedor</th>
                                    <th>Pontuação</th>
                                    <th>Confirmar</th>
                                </tr>
                            </thead>
                            <tbody id="winnersTableBody">
                                {% for partida in partidas %}
                                <tr>
                                    <td>Partida #{{ partida.numero }} -
                                        {% if partida.aka %}{{ partida.aka.nome_completo }}{% else %}Bye{% endif %} vs
                                        {% if partida.ao %}{{ partida.ao.nome_completo }}{% else %}Bye{% endif %}
                                    </td>
                                    <td>
                                        <select class="form-select form-select-sm winner-select" data-match="{{ partida.numero }}">
                                            <option value="">Selecione...</option>
                                            {% if partida.aka %}
                                            <option value="{{ partida.aka.id }}">{{ partida.aka.nome_completo }}</option>
                                            {% endif %}
                                            {% if partida.ao %}
                                            <option value="{{ partida.ao.id }}">{{ partida.ao.nome_completo }}</option>
                                            {% endif %}
                                        </select>
                                    </td>
                                    <td class="fw-bold">0-0</td>
                                    <td class="text-center">
                                        <input type="checkbox" class="form-check-input confirm-checkbox" data-match="{{ partida.numero }}">
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle-fill me-2"></i> Apenas partidas finalizadas e com vencedores confirmados serão avançadas para a próxima fase.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" onclick="advanceWinners()">Avançar Vencedores</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Campeão -->
    <div class="modal fade" id="championModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="bi bi-trophy-fill me-2"></i> Campeão da Categoria</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="modal-icon text-warning">
                        <i class="bi bi-trophy-fill"></i>
                    </div>
                    <h4 id="championName"></h4>
                    <p class="mb-0">Parabéns ao campeão da categoria <strong>{{ categoria.nome }}</strong>!</p>
                    <div class="d-flex justify-content-center mt-4">
                        <button type="button" class="btn btn-warning" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variáveis globais
        let currentMatchToFinish = null;
        let currentMatchToCancel = null;
        let currentPenaltyMatch = null;
        let currentPenaltyAthlete = null;
        let currentPhase = {{ current_phase }};
        let maxPhases = {{ max_phases }};
        let champion = null;

        // Inicializa os modais
        const finishMatchModal = new bootstrap.Modal(document.getElementById('finishMatchModal'));
        const cancelMatchModal = new bootstrap.Modal(document.getElementById('cancelMatchModal'));
        const advanceModal = new bootstrap.Modal(document.getElementById('advanceModal'));
        const championModal = new bootstrap.Modal(document.getElementById('championModal'));

        // Estrutura para armazenar partidas
        const allMatches = {};

        // Inicializa os timers
        const matchTimers = {};
        {% for partida in partidas %}
        matchTimers[{{ partida.numero }}] = {
            interval: null,
            minutes: 2,
            seconds: 0,
            running: false
        };
        {% endfor %}

        // Função para preparar finalização da partida
        function prepareFinishMatch(matchId) {
            currentMatchToFinish = matchId;
            finishMatchModal.show();
        }

        // Confirmar finalização da partida
        document.getElementById('confirmFinishMatch').addEventListener('click', function() {
            if (currentMatchToFinish) {
                finishMatch(currentMatchToFinish);
                finishMatchModal.hide();
            }
        });

        // Função para preparar cancelamento da partida
        function prepareCancelMatch(matchId) {
            currentMatchToCancel = matchId;
            cancelMatchModal.show();
        }

        // Confirmar cancelamento da partida
        document.getElementById('confirmCancelMatch').addEventListener('click', function() {
            if (currentMatchToCancel) {
                cancelMatch(currentMatchToCancel);
                cancelMatchModal.hide();
            }
        });

        // Função para desabilitar inputs de uma partida
        function disableMatchInputs(matchId) {
            const inputs = document.querySelectorAll(`.score-input[data-match="${matchId}"]`);
            inputs.forEach(input => {
                input.disabled = true;
                input.classList.add('disabled-input');
            });

            const buttons = document.querySelectorAll(`button[onclick="addPoint(${matchId},1)"], button[onclick="addPoint(${matchId},2)"]`);
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.classList.add('disabled');
            });
        }

        // Função para finalizar partida
        function finishMatch(matchId) {
            clearInterval(matchTimers[matchId].interval);
            matchTimers[matchId].running = false;

            // Determina o vencedor
            const scoreAka = parseInt(document.querySelector(`.score-input[data-match="${matchId}"][data-athlete="1"]`).value) || 0;
            const scoreAo = parseInt(document.querySelector(`.score-input[data-match="${matchId}"][data-athlete="2"]`).value) || 0;
            let winner = null;

            if (scoreAka > scoreAo) {
                winner = 'AKA';
            } else if (scoreAo > scoreAka) {
                winner = 'AO';
            } else {
                winner = 'Empate';
            }

            // Atualiza status da partida
            const statusBadge = document.querySelector(`#match-${matchId} .match-status-badge`);
            if (statusBadge) {
                statusBadge.classList.remove('bg-success', 'bg-warning', 'bg-secondary');
                statusBadge.classList.add('bg-info');
                statusBadge.textContent = 'Finalizada';

                // Adiciona badge ao vencedor
                if (winner !== 'Empate') {
                    const winnerSide = winner === 'AKA' ? '1' : '2';
                    const winnerDiv = document.querySelector(`.athlete-info:nth-child(${winnerSide})`, document.querySelector(`#match-${matchId}`));
                    if (winnerDiv) {
                        const championBadge = document.createElement('span');
                        championBadge.className = 'badge champion-badge ms-2';
                        championBadge.innerHTML = '<i class="bi bi-trophy-fill"></i> Vencedor';
                        winnerDiv.querySelector('.flex-grow-1').appendChild(championBadge);
                    }
                }
            }

            // Desabilita inputs
            disableMatchInputs(matchId);

            // Atualiza a tabela de resumo
            updateSummaryTable(matchId, scoreAka, scoreAo, 'Finalizada');

            console.log(`Partida #${matchId} finalizada. Vencedor: ${winner} (${scoreAka}-${scoreAo})`);
        }

        // Função para cancelar partida
        function cancelMatch(matchId) {
            clearInterval(matchTimers[matchId].interval);
            matchTimers[matchId].running = false;

            // Atualiza status da partida
            const statusBadge = document.querySelector(`#match-${matchId} .match-status-badge`);
            if (statusBadge) {
                statusBadge.classList.remove('bg-success', 'bg-warning', 'bg-secondary', 'bg-info');
                statusBadge.classList.add('bg-danger');
                statusBadge.textContent = 'Cancelada';
            }

            // Desabilita inputs
            disableMatchInputs(matchId);

            // Atualiza a tabela de resumo
            updateSummaryTable(matchId, 0, 0, 'Cancelada');

            console.log(`Partida #${matchId} cancelada`);
        }

        // Função para mostrar modal de penalidades
        function showPenaltyModal(matchId, athleteId) {
            currentPenaltyMatch = matchId;
            currentPenaltyAthlete = athleteId;

            const athleteElement = document.querySelector(`.athlete-info:nth-child(${athleteId}) h6`,
                document.querySelector(`#match-${matchId}`));
            const athleteName = athleteElement ? athleteElement.textContent.trim() : 'Atleta';

            document.getElementById('athleteName').value = `${athleteName} (${athleteId === 1 ? 'AKA' : 'AO'})`;
            document.getElementById('penaltyType').value = 'C1';
            document.getElementById('penaltyReason').value = '';

            penaltyModal.show();
        }

        // Função para adicionar penalidade
        function addPenalty() {
            if (!currentPenaltyMatch || !currentPenaltyAthlete) return;

            const penaltyType = document.getElementById('penaltyType').value;
            const penaltyReason = document.getElementById('penaltyReason').value;

            // Adiciona a penalidade visualmente
            const penaltiesContainer = document.querySelector(`.penalties[data-match="${currentPenaltyMatch}"][data-athlete="${currentPenaltyAthlete}"]`);

            let badgeClass = 'bg-danger';
            if (penaltyType === 'H1' || penaltyType === 'H2') {
                badgeClass = 'bg-warning text-dark';
            }

            const badge = document.createElement('span');
            badge.className = `badge ${badgeClass} penalty-badge me-1`;
            badge.textContent = penaltyType;
            badge.title = penaltyReason || 'Penalidade aplicada';

            penaltiesContainer.appendChild(badge);

            penaltyModal.hide();
        }

        // Função para atualizar a tabela de resumo
        function updateSummaryTable(matchId, scoreAka, scoreAo, status) {
            const row = document.querySelector(`table tbody tr:nth-child(${matchId})`);
            if (row) {
                const cells = row.cells;
                cells[3].textContent = scoreAka;
                cells[5].textContent = scoreAo;

                // Atualiza status
                const statusBadge = cells[6].querySelector('.badge');
                if (statusBadge) {
                    statusBadge.className = 'badge ' +
                        (status === 'Finalizada' ? 'bg-info' :
                         status === 'Cancelada' ? 'bg-danger' : 'bg-secondary');
                    statusBadge.textContent = status;
                }
            }
        }

        // Função para avançar vencedores
        function advanceWinners() {
            const winners = [];
            let hasUnconfirmed = false;

            // Coleta os vencedores confirmados
            document.querySelectorAll('.winner-select').forEach(select => {
                const matchId = select.dataset.match;
                const checkbox = document.querySelector(`.confirm-checkbox[data-match="${matchId}"]`);

                if (select.value && checkbox.checked) {
                    winners.push({
                        matchId: parseInt(matchId),
                        athleteId: parseInt(select.value),
                        athleteName: select.options[select.selectedIndex].text
                    });
                } else if (select.value && !checkbox.checked) {
                    hasUnconfirmed = true;
                }
            });

            if (winners.length === 0) {
                alert('Nenhum vencedor foi selecionado ou confirmado!');
                return;
            }

            if (hasUnconfirmed) {
                if (!confirm('Alguns vencedores não foram confirmados. Deseja avançar apenas os confirmados?')) {
                    return;
                }
            }

            // Aqui você enviaria os dados para o servidor
            console.log('Vencedores a avançar:', winners);

            // Simula o avanço para a próxima fase
            if (currentPhase < maxPhases) {
                currentPhase++;
                alert(`Vencedores avançados para a fase ${currentPhase}! Atualizando a página...`);
                // Na implementação real, você redirecionaria para a próxima fase
                window.location.href = window.location.href;
            } else {
                // Se for a final, define o campeão
                if (winners.length === 1) {
                    champion = winners[0];
                    showChampion(champion.athleteName);
                }
            }

            advanceModal.hide();
        }

        // Função para mostrar o campeão
        function showChampion(championName) {
            document.getElementById('championName').textContent = championName;
            championModal.show();
        }

        // Função para alternar o timer da partida
        function toggleMatchTimer(matchId) {
            const timer = matchTimers[matchId];
            const btn = document.querySelector(`button[onclick="toggleMatchTimer(${matchId})"] i`);

            if (timer.running) {
                clearInterval(timer.interval);
                btn.classList.remove('bi-pause-fill');
                btn.classList.add('bi-play-fill');
                document.querySelector(`button[onclick="toggleMatchTimer(${matchId})"]`).innerHTML = '<i class="bi bi-play-fill"></i> Play';
            } else {
                startTimer(matchId);
                btn.classList.remove('bi-play-fill');
                btn.classList.add('bi-pause-fill');
                document.querySelector(`button[onclick="toggleMatchTimer(${matchId})"]`).innerHTML = '<i class="bi bi-pause-fill"></i> Pause';
            }

            timer.running = !timer.running;
            updateMatchStatus(matchId);
        }

        // Função para iniciar o timer
        function startTimer(matchId) {
            const timer = matchTimers[matchId];

            if (timer.interval) {
                clearInterval(timer.interval);
            }

            timer.interval = setInterval(() => {
                if (timer.seconds === 0) {
                    if (timer.minutes === 0) {
                        clearInterval(timer.interval);
                        finishMatch(matchId);
                        return;
                    }
                    timer.minutes--;
                    timer.seconds = 59;
                } else {
                    timer.seconds--;
                }
                updateTimerDisplay(matchId);
            }, 1000);
        }

        // Função para resetar o timer
        function resetMatchTimer(matchId) {
            const timer = matchTimers[matchId];
            clearInterval(timer.interval);
            timer.minutes = 2;
            timer.seconds = 0;
            timer.running = false;
            updateTimerDisplay(matchId);

            const btn = document.querySelector(`button[onclick="toggleMatchTimer(${matchId})"] i`);
            btn.classList.remove('bi-pause-fill');
            btn.classList.add('bi-play-fill');
            document.querySelector(`button[onclick="toggleMatchTimer(${matchId})"]`).innerHTML = '<i class="bi bi-play-fill"></i> Play';

            updateMatchStatus(matchId);
        }

        // Função para atualizar o display do timer
        function updateTimerDisplay(matchId) {
            const timer = matchTimers[matchId];
            const display = document.querySelector(`.timer-display[data-match="${matchId}"]`);
            display.textContent = `${timer.minutes.toString().padStart(2, '0')}:${timer.seconds.toString().padStart(2, '0')}`;
        }

        // Função para atualizar o status da partida
        function updateMatchStatus(matchId) {
            const timer = matchTimers[matchId];
            const statusBadge = document.querySelector(`#match-${matchId} .match-status-badge`);

            if (!statusBadge) return;

            statusBadge.classList.remove('bg-success', 'bg-warning', 'bg-secondary', 'bg-info', 'bg-danger');

            if (timer.running) {
                statusBadge.classList.add('bg-success');
                statusBadge.textContent = 'Em Andamento';
            } else if (timer.minutes === 2 && timer.seconds === 0) {
                statusBadge.classList.add('bg-secondary');
                statusBadge.textContent = 'Não Iniciada';
            } else {
                statusBadge.classList.add('bg-warning', 'text-dark');
                statusBadge.textContent = 'Pausada';
            }
        }

        // Função para adicionar pontos
        function addPoint(matchId, athleteId) {
            const input = document.querySelector(`.score-input[data-match="${matchId}"][data-athlete="${athleteId}"]`);
            input.value = parseInt(input.value) + 1;
        }

        // Função para adicionar tempo
        function addTime(matchId, seconds) {
            const timer = matchTimers[matchId];
            timer.seconds += seconds;

            while (timer.seconds >= 60) {
                timer.seconds -= 60;
                timer.minutes += 1;
            }

            updateTimerDisplay(matchId);
        }

        // Função para iniciar todas as partidas
        function startAllMatches() {
            for (let matchId in matchTimers) {
                if (!matchTimers[matchId].running) {
                    startTimer(matchId);
                    matchTimers[matchId].running = true;
                    const btn = document.querySelector(`button[onclick="toggleMatchTimer(${matchId})"] i`);
                    if (btn) {
                        btn.classList.remove('bi-play-fill');
                        btn.classList.add('bi-pause-fill');
                        document.querySelector(`button[onclick="toggleMatchTimer(${matchId})"]`).innerHTML = '<i class="bi bi-pause-fill"></i> Pause';
                    }
                    updateMatchStatus(matchId);
                }
            }
        }

        // Função para pausar todas as partidas
        function pauseAllMatches() {
            for (let matchId in matchTimers) {
                if (matchTimers[matchId].running) {
                    clearInterval(matchTimers[matchId].interval);
                    matchTimers[matchId].running = false;
                    const btn = document.querySelector(`button[onclick="toggleMatchTimer(${matchId})"] i`);
                    if (btn) {
                        btn.classList.remove('bi-pause-fill');
                        btn.classList.add('bi-play-fill');
                        document.querySelector(`button[onclick="toggleMatchTimer(${matchId})"]`).innerHTML = '<i class="bi bi-play-fill"></i> Play';
                    }
                    updateMatchStatus(matchId);
                }
            }
        }

        // Função para focar em uma partida específica
        function focusMatch(matchId) {
            const matchElement = document.getElementById(`match-${matchId}`);
            if (matchElement) {
                matchElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                matchElement.style.boxShadow = '0 0 0 3px rgba(13, 110, 253, 0.5)';
                setTimeout(() => {
                    matchElement.style.boxShadow = '0 4px 10px rgba(0, 0, 0, 0.08)';
                }, 2000);
            }
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            // Atualiza os displays dos timers
            for (let matchId in matchTimers) {
                updateTimerDisplay(matchId);
                updateMatchStatus(matchId);
            }
        });
    </script>
</body>
</html>